import { prisma } from '@/lib/prisma'

export interface StoreSettings {
  store_name: string
  store_description: string
  store_email: string
  store_phone: string
  store_address: string
  store_city: string
  store_country: string
  store_currency: string
  store_timezone: string
  store_logo: string
}

export interface PaymentSettings {
  payment_payfast_enabled: boolean
  payment_payfast_merchant_id: string
  payment_payfast_merchant_key: string
  payment_payfast_passphrase: string
  payment_payfast_sandbox: boolean
  payment_stripe_enabled: boolean
  payment_stripe_public_key: string
  payment_stripe_secret_key: string
  payment_stripe_webhook: string
}

export interface NotificationSettings {
  notification_order_notifications: boolean
  notification_customer_notifications: boolean
  notification_inventory_alerts: boolean
  notification_marketing_emails: boolean
  notification_sms_notifications: boolean
}

export interface SecuritySettings {
  security_two_factor_auth: boolean
  security_session_timeout: number
  security_password_expiry: number
  security_login_attempts: number
}

export type AllSettings = StoreSettings & PaymentSettings & NotificationSettings & SecuritySettings

// Default settings
export const defaultSettings: AllSettings = {
  // Store settings
  store_name: 'AllDeals',
  store_description: 'Your one-stop shop for amazing deals on electronics, gaming, and more.',
  store_email: 'info@alldeals.com',
  store_phone: '+27 21 123 4567',
  store_address: '123 Main Street, City Bowl',
  store_city: 'Cape Town',
  store_country: 'South Africa',
  store_currency: 'ZAR',
  store_timezone: 'Africa/Johannesburg',
  store_logo: '',

  // Payment settings
  payment_payfast_enabled: true,
  payment_payfast_merchant_id: '10000100',
  payment_payfast_merchant_key: '46f0cd694581a',
  payment_payfast_passphrase: 'jt7NOE43FZPn',
  payment_payfast_sandbox: true,
  payment_stripe_enabled: false,
  payment_stripe_public_key: '',
  payment_stripe_secret_key: '',
  payment_stripe_webhook: '',

  // Notification settings
  notification_order_notifications: true,
  notification_customer_notifications: true,
  notification_inventory_alerts: true,
  notification_marketing_emails: false,
  notification_sms_notifications: false,

  // Security settings
  security_two_factor_auth: false,
  security_session_timeout: 30,
  security_password_expiry: 90,
  security_login_attempts: 5
}

// Get all settings with fallback to defaults
export async function getSettings(): Promise<AllSettings> {
  try {
    const settings = await prisma.setting.findMany()
    
    const settingsObject = settings.reduce((acc: any, setting) => {
      let value = setting.value
      
      // Parse value based on type - keep as strings for consistency
      switch (setting.type) {
        case 'boolean':
          value = setting.value === 'true' ? 'true' : 'false'
          break
        case 'number':
          value = setting.value
          break
        case 'json':
          try {
            value = JSON.parse(setting.value)
          } catch {
            value = setting.value
          }
          break
        default:
          value = setting.value
      }

      acc[setting.key] = value
      return acc
    }, {})

    // Merge with defaults to ensure all settings exist
    return { ...defaultSettings, ...settingsObject }
  } catch (error) {
    console.error('Error fetching settings:', error)
    return defaultSettings
  }
}

// Get settings by category
export async function getSettingsByCategory(category: string): Promise<Partial<AllSettings>> {
  try {
    const settings = await prisma.setting.findMany({
      where: { category }
    })
    
    const settingsObject = settings.reduce((acc: any, setting) => {
      let value = setting.value
      
      switch (setting.type) {
        case 'boolean':
          value = setting.value === 'true'
          break
        case 'number':
          value = parseFloat(setting.value)
          break
        case 'json':
          try {
            value = JSON.parse(setting.value)
          } catch {
            value = setting.value
          }
          break
        default:
          value = setting.value
      }

      acc[setting.key] = value
      return acc
    }, {})

    return settingsObject
  } catch (error) {
    console.error('Error fetching settings by category:', error)
    return {}
  }
}

// Initialize default settings in database
export async function initializeDefaultSettings() {
  try {
    const existingSettings = await prisma.setting.findMany()
    const existingKeys = new Set(existingSettings.map(s => s.key))

    const settingsToCreate = Object.entries(defaultSettings)
      .filter(([key]) => !existingKeys.has(key))
      .map(([key, value]) => {
        let stringValue: string
        let type: string

        if (typeof value === 'boolean') {
          stringValue = value.toString()
          type = 'boolean'
        } else if (typeof value === 'number') {
          stringValue = value.toString()
          type = 'number'
        } else if (typeof value === 'object') {
          stringValue = JSON.stringify(value)
          type = 'json'
        } else {
          stringValue = String(value)
          type = 'string'
        }

        let category = 'general'
        if (key.startsWith('store_')) category = 'store'
        else if (key.startsWith('payment_')) category = 'payment'
        else if (key.startsWith('notification_')) category = 'notification'
        else if (key.startsWith('security_')) category = 'security'

        return {
          key,
          value: stringValue,
          type,
          category
        }
      })

    if (settingsToCreate.length > 0) {
      await prisma.setting.createMany({
        data: settingsToCreate
      })
      console.log(`Initialized ${settingsToCreate.length} default settings`)
    }
  } catch (error) {
    console.error('Error initializing default settings:', error)
  }
}
